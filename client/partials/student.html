<iframe style="position: fixed; display: block; width: 0px; height: 0px; visibility: hidden; right: 0;" id="iframe" name="iframe">
</iframe>

<div ng-include src="top_bar_url"></div>
<div class="row-fluid content">

    <div class="span4" ng-hide="isMobile && (isSelectedAl() || isNewAl());">
        <div class="menu shadow">
            <div>
                <a href="#" ng-click="reload();" class="text-right">Refresh Activity Logs <i class="icon-refresh"></i></a>
            </div>
            <ul>
                <li>
                    <select ng-model="mode" class="edit-field" ng-change="reload();" style="width: 96%; margin: 2%;">
                        <option ng-repeat="m in modes.modes">{{m}}</option>
                    </select>
                </li>
                <li ng-repeat="al in menu | orderBy:'-modified_num'" ng-class="isSelectedAl(al.id)" class="{{question(al.id)}}">
                    <a href="#" ng-click="selectAL(al.id);">
                        {{al.title}}<br>
                        <small class="author">
                            by: {{DB.d.users[ DB.d.als[al.id].user_id ].username}}<br>
                            <span class="badge badge-info" ng-show="DB.m.als[al.id].media.length > 0">HAS MEDIA</span>
                            <span class="badge badge-info" ng-show="DB.m.als[al.id].comments.length > 0">HAS COMMENTS</span>
                        </small>
                        <i ng-show="DB.m.als[al.id].mode == 'edit'" class="icon-pencil"></i>
                    </a>
                    <div class="functions">
                        <button class="btn-link function" ng-click="deleteAl(false, al.id);"
                                ng-hide="DB.m.als[al.id].mode == 'deleting' || DB.m.als[al.id].mode == 'edit' || DB.d.users[ DB.d.als[al.id].user_id ].id != user.User.id"><i class="icon-remove"></i></button>
                    </div>
                    <div class="confirms">
                        <button class="btn btn-danger confirm" ng-click="deleteAl(true, al.id);" ng-show="DB.m.als[al.id].mode == 'deleting';">Delete</button>
                        <button class="btn btn-success confirm" ng-click="DB.m.als[al.id].mode = 'normal';" ng-show="DB.m.als[al.id].mode == 'deleting';">Keep</button>
                    </div>
                </li>
            </ul>
            <div>
            </div>
        </div>
    </div>

    <div class="span8" ng-show="isNewAl();">
        <form id="alform" ng-submit="submitNewAl();" class="" target="iframe" action='/activity_logs' method='POST' enctype='multipart/form-data'>
        <div class="menu shadow">
            <div>
                <span>
                    <input autofocus="true" onload="this.focus()" type="text" class="input-xxlarge" placeholder="Title" name="data[ActivityLog][title]">
                </span>
            </div>
            <ul>
                <li>
                    <div class="selector">
                        <!--<textarea class="edit-field" ng-model="new_activity_log.content" name="data[ActivityLog][title]"></textarea>-->
                        <div class="control-group">
                            <!--<label class="control-label" for="data[ActivityLog][content]">Content</label>-->
                            <div class="controls">
                                <textarea name='data[ActivityLog][content]' placeholder="Content"></textarea>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label" for="data[ActivityLog][visibility_level]">Visibility level</label>
                            <div class="controls">
                                <select name='data[ActivityLog][visibility_level]'>
                                    <option selected>PRIVATE</option>
                                    <option>SUPERVISOR</option>
                                    <option>TEAM</option>
                                    <option>PUBLIC</option>
                                </select>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="controls">
                                <label class="checkbox">
                                    <input name='data[ActivityLog][question]' type="checkbox"> Question
                                </label>
                            </div>
                        </div>

                        <div class="control-group">
                            <div class="controls">
                                <label class="cont rol-label" for="data[ActivityLog][visibility_level]">Files</label>
                            </div>
                        </div>
                        <div class="control-group" ng-repeat="file in files">
                            <div class="controls">
                                <input type='file' name='data[Media][{{$index}}]' >
                                <span class="btn btn-link" ng-click='removeFile($index);'><button class="btn btn-mini btn-warning"><i class="icon-remove"></i></button></span>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="controls">
                                <span tabindex="-1" class="btn" ng-click='addFile();'><i class="icon-file"></i> add file</span>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
            <div>
                <span>
                    <div class="btn-group">
                        <button ng-disabled="BUSY.busy();" ng-click="startWatching();" type="submit" class="btn">Save</button>
                        <button type="button" class="btn" ng-click="removeNewAl();">Cancel</button>
                    </div>
                </span>
            </div>
        </div>
        </form>
    </div>

    <div class="span8" ng-hide="isNewAl();">
        <div class="menu shadow" ng-show="isSelectedAl();">
            <div class="{{question(selected_al)}}">
                <span ng-show="DB.d.users[ DB.d.als[selected_al].user_id ].id == user.User.id;">

                    <h4 class="clickable" ng-hide="DB.m.als[selected_al].mode == 'edit'" ng-click="editAl(selected_al);">
                        <button ng-show="isMobile" class="btn btn-link" ng-click="selected_al = null;"><i class="icon-backward"></i> </button>
                        {{DB.d.als[selected_al].title}} <i class="icon-pencil"></i>
                        <!--{{DB.d.als[selected_al].modified}} / {{DB.d.als[selected_al].created}}-->
                    </h4>
                    <!-- EDIT MODE -->
                    <span ng-show="DB.m.als[selected_al].mode == 'edit'">
                        <input autofocus="true" onload="this.focus()" type="text" class="input-xxlarge" ng-model="DB.d.als[selected_al].title">
                    </span>
                </span>
                <span ng-hide="DB.d.users[ DB.d.als[selected_al].user_id ].id == user.User.id;">
                    <h4>
                        <button ng-show="isMobile" class="btn btn-link" ng-click="selected_al = null;"><i class="icon-backward"></i> </button>
                        {{DB.d.als[selected_al].title}}
                    </h4>
                </span>
            </div>
            <ul>
                <li>
                    <p class="selector" ng-hide="DB.m.als[selected_al].mode == 'edit'">
                        {{DB.d.als[selected_al].content}}
                    </p>
                    <!-- EDIT MODE -->
                    <textarea class="edit-field" ng-model="DB.d.als[selected_al].content" ng-show="DB.m.als[selected_al].mode == 'edit'"></textarea>
                </li>
            </ul>
            <div ng-show="DB.m.als[selected_al].mode == 'edit'">
                <span>
                    <div class="btn-group">
                        <button ng-disabled="BUSY.busy();" type="submit" class="btn" ng-click="saveAl(selected_al);">Save</button>
                        <button ng-disabled="" type="button" class="btn" ng-click="cancelEditAl(selected_al);">Cancel</button>
                    </div>
                </span>
            </div>
            <div ng-show="isSelectedAl();">
                <a href="#" ng-click="toggleShowInfo(selected_al);">
                    <strong>Info</strong>
                    <i class="icon-circle-arrow-right" ng-hide="showInfo(selected_al);"></i>
                    <i class="icon-circle-arrow-down" ng-show="showInfo(selected_al);"></i>
                </a>
            </div>
            <ul ng-show="showInfo(selected_al);">
                <li>
                    <span class="selector">
                        <p><strong>Author:</strong> {{DB.d.users[ DB.d.als[selected_al].user_id ].username}}<span ng-show="DB.d.users[ DB.d.als[selected_al].user_id ].id == user.User.id;"> ( You )</span></p>
                        <p><strong>Created:</strong> {{DB.d.als[selected_al].created}}<br></p>
                        <p><strong>Modified:</strong> {{DB.d.als[selected_al].modified}}</p>
                    </span>
                </li>
            </ul>
            <div ng-show="isSelectedAl();">
                <a href="#" ng-click="toggleShowMedia(selected_al);">
                    <strong>Media</strong>
                    <span class="badge" ng-show="DB.m.als[selected_al].media != null && DB.m.als[selected_al].media.length > 0;" style="float: right">
                        {{DB.m.als[selected_al].media.length}}
                    </span>
                    <i class="icon-circle-arrow-right" ng-hide="showMedia(selected_al);"></i>
                    <i class="icon-circle-arrow-down" ng-show="showMedia(selected_al);"></i>
                </a>
            </div>
            <ul>
                <li ng-show="showMedia(selected_al) && (DB.m.als[selected_al].media == null || DB.m.als[selected_al].media.length == 0);">
                    <div class="selector"><em>No Media present...</em></div>
                </li>
                <li ng-show="showMedia(selected_al) && (DB.m.als[selected_al].media != null && DB.m.als[selected_al].media.length > 0);">
                    <ul class="thumbnails">
                        <li ng-repeat="m in DB.m.als[selected_al].media" class="span3" style="margin: 3px">
                            <div class="thumbnail" ng-click="download(m);"  class="clickable">
                                <img src="/media/download/{{m}}?thumb=BIG" alt="{{DB.d.media[m].filename}}" ng-show="DB.d.media[m]['content-type'].indexOf('image/') == 0">
                                <img src="{{getThumbUrl(DB.d.media[m]['content-type']);}}" alt="{{DB.d.media[m].filename}}" ng-hide="DB.d.media[m]['content-type'].indexOf('image/') == 0">
                                <p>{{DB.d.media[m].filename}}</p>
                            </div>
                        </li>
                    </ul>
                </li>
            </ul>
            <div ng-show="isSelectedAl();">
                <a href="#" ng-click="toggleShowComments(selected_al);">
                    <strong>Comments</strong>
                    <span class="badge" ng-show="DB.m.als[selected_al].comments != null && DB.m.als[selected_al].comments.length" style="float: right">
                        {{DB.m.als[selected_al].comments.length}}
                    </span>
                    <i class="icon-circle-arrow-right" ng-hide="showComments(selected_al);"></i>
                    <i class="icon-circle-arrow-down" ng-show="showComments(selected_al);"></i>
                </a>
            </div>
            <ul>
                <li ng-show="showComments(selected_al) && (DB.m.als[selected_al].comments == null || DB.m.als[selected_al].comments.length == 0);">
                    <div class="selector"><em>No Comments yet...</em></div>
                </li>
                <li ng-repeat="c in DB.m.als[selected_al].comments | orderBy:'-modified'" ng-show="showComments(selected_al);">
                    <p class="selector"><strong>{{DB.d.users[DB.d.comments[c].user_id].username}} says:</strong></p>
                    <p class="selector">{{DB.d.comments[c].content}}</p>
                    <p class="selector"><strong>on:</strong> {{DB.d.comments[c].modified}}</p>
                    <ul class="thumbnails">
                        <li ng-repeat="m in DB.m.comments[c].media" class="span3" style="margin: 3px">
                            <div class="thumbnail" ng-click="download(m);" class="clickable">
                                <img src="/media/download/{{DB.d.media[m].id}}?thumb=BIG" alt="{{DB.d.media[m].filename}}" ng-show="DB.d.media[m]['content-type'].indexOf('image/') == 0">
                                <img src="{{getThumbUrl(DB.d.media[m]['content-type']);}}" alt="{{DB.d.media[m].filename}}" ng-hide="DB.d.media[m]['content-type'].indexOf('image/') == 0">
                                <p>{{DB.d.media[m].filename}}</p>
                            </div>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>

        </div>
    </div>

</div>